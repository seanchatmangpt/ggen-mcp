# ggen-mcp Development Session

## Session Info
**Date**: 2026-01-19
**Location**: `/Users/sac/ggen-mcp`
**Status**: Bootstrapping complete, needs full DDD implementation

## Current State

**Working** (2/10 files):
- `src/domain/aggregates.rs` - Ontology, Receipt with complete validation
- `src/domain/commands.rs` - LoadOntologyCommand, GenerateCodeCommand

**Missing** (8/10 files):
- `src/domain/value_objects.rs` - OntologyId, ReceiptId, SPARQLQuery, Template
- `src/domain/events.rs` - OntologyLoaded, CodeGenerated  
- `src/domain/repositories.rs` - Persistence traits
- `src/domain/policies.rs` - CompletenessPolicy, DeterminismPolicy
- `src/domain/mod.rs` - Module exports
- `src/application/services.rs` - OntologyService, GenerationService
- `src/application/handlers.rs` - Command handlers
- `src/application/mod.rs` - Module exports

## Key Decisions

**Paradigm**: Ontology IS source, not input to generator. No `generated/` folder - writes to `src/` directly.

**TPS Principles**:
- Andon: Stop if ggen sync fails
- Jidoka: Templates error on incomplete ontology ({{ error() }})
- Single Piece Flow: One component → sync → verify
- Big Bang 80/20: Complete or fail, never partial

**Meta-Circular**: System generates own domain code from ggen-mcp.ttl

## Files Created

**Ontology**: `ggen-mcp.ttl` (96 lines)
- 2 Aggregates: Ontology, Receipt
- 2 Commands: LoadOntology, GenerateCode
- 2 Events: OntologyLoaded, CodeGenerated (partial)
- Properties with Rust types
- Invariants with validation code in ddd:check

**Config**: `ggen.toml` (4/10 rules)
- Writes directly to src/domain/, src/application/
- Mode: Overwrite

**Queries**: 
- `queries/aggregates.rq` ✅
- `queries/commands.rq` ✅

**Templates**:
- `templates/aggregate.rs.tera` ✅
- `templates/command.rs.tera` ✅

**Documentation**:
- `CLAUDE.md` - Project memory
- `CLAUDE-DESKTOP.md` - TCPS operations standard
- `CORRECTED_FILES_COMPLETE.md` - Initial bootstrap log

## Next Steps (Priority Order)

**Phase 1**: Expand ggen-mcp.ttl
- ValueObject definitions with properties
- Repository traits with methods
- Service operations
- Handler implementations
- Policy rules with checks
- Complete Event definitions

**Phase 2**: Create 6 missing queries
- `value_objects.rq`, `repositories.rq`, `services.rq`
- `handlers.rq`, `policies.rq`, `events.rq`

**Phase 3**: Create 6 missing templates
- `value_object.rs.tera`, `repository.rs.tera`, `service.rs.tera`
- `handler.rs.tera`, `policy.rs.tera`, `event.rs.tera`

**Phase 4**: Create 2 module templates
- `domain_mod.rs.tera`, `application_mod.rs.tera`

**Phase 5**: Update ggen.toml with all 10 rules

**Phase 6**: Run ggen sync - must complete all 10 files

**Phase 7**: Verify
- grep -r "TODO" src/ (must be empty)
- cargo check (must succeed)
- All validate() have actual code
- Meta-circular test passes

**Phase 8**: MCP Integration
- Wire ontology cache into AppState
- Create src/tools/ontology.rs
- Register tools in server.rs

## Template Pattern

```tera
{% for row in sparql_results -%}
{%- set label = row["?label"] | default(value="Unknown") -%}

pub struct {{ label | replace(from=" ", to="") }} {
    // Properties
}
{% endfor %}
```

## Quality Gates

**Before Sync**:
- Ontology syntax valid (Turtle)
- All queries/templates exist
- ggen.toml references correct paths

**After Sync**:
- 10 files created
- Zero TODO
- cargo check passes
- File sizes > 100 bytes

**Meta-Circular Test**:
- Modify ggen:Ontology in ggen-mcp.ttl
- Run ggen sync
- Verify src/domain/aggregates.rs changed
- System uses new structure

## Commands

- `O:[change]` - Modify ontology
- `G` - Run ggen sync
- `S` - Status check  
- `M:[tool]` - Implement MCP tool
- `F` - Finalize

## Success Criteria

- [ ] 10 files in src/
- [ ] Zero TODO
- [ ] cargo build succeeds
- [ ] Meta-circular test passes
- [ ] MCP tools registered
- [ ] Tests >90% coverage

**Resume Point**: Phase 1 - Expand ontology with ValueObjects