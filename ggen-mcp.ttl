@prefix ggen: <https://ggen-mcp.dev/domain#> .
@prefix ddd: <https://ddd-patterns.dev/schema#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

# Property Definitions
ggen:id a ddd:Property ;
    rdfs:label "id" ;
    ddd:type "String" .

ggen:path a ddd:Property ;
    rdfs:label "path" ;
    ddd:type "PathBuf" .

ggen:graph a ddd:Property ;
    rdfs:label "graph" ;
    ddd:type "Graph" .

ggen:receiptId a ddd:Property ;
    rdfs:label "receipt_id" ;
    ddd:type "String" .

ggen:ontologyHash a ddd:Property ;
    rdfs:label "ontology_hash" ;
    ddd:type "String" .

ggen:templateHash a ddd:Property ;
    rdfs:label "template_hash" ;
    ddd:type "String" .

ggen:artifactHash a ddd:Property ;
    rdfs:label "artifact_hash" ;
    ddd:type "String" .

ggen:timestamp a ddd:Property ;
    rdfs:label "timestamp" ;
    ddd:type "Instant" .

# Ontology Aggregate
ggen:Ontology a ddd:AggregateRoot ;
    rdfs:label "Ontology" ;
    rdfs:comment "RDF ontology loaded into memory" ;
    ddd:hasProperty ggen:id ;
    ddd:hasProperty ggen:path ;
    ddd:hasProperty ggen:graph ;
    ddd:hasInvariant [
        rdfs:label "Graph must be non-empty" ;
        ddd:check "self.graph.len() > 0" ;
        ddd:message "RDF graph cannot be empty"
    ] ;
    ddd:hasInvariant [
        rdfs:label "ID must match pattern" ;
        sh:path ggen:id ;
        sh:pattern "^ont-[a-z0-9]{10}$" ;
        ddd:check "Regex::new(r\"^ont-[a-z0-9]{10}$\").unwrap().is_match(&self.id)" ;
        ddd:message "ID must match pattern: ont-[a-z0-9]{10}"
    ] .

# Receipt Aggregate
ggen:Receipt a ddd:AggregateRoot ;
    rdfs:label "Receipt" ;
    rdfs:comment "Provenance receipt for generated code" ;
    ddd:hasProperty ggen:receiptId ;
    ddd:hasProperty ggen:ontologyHash ;
    ddd:hasProperty ggen:templateHash ;
    ddd:hasProperty ggen:artifactHash ;
    ddd:hasProperty ggen:timestamp ;
    ddd:hasInvariant [
        rdfs:label "All hashes must be present" ;
        ddd:check "!self.ontology_hash.is_empty() && !self.template_hash.is_empty() && !self.artifact_hash.is_empty()" ;
        ddd:message "All hashes (ontology, template, artifact) are required"
    ] .

# Commands
ggen:LoadOntologyCommand a ddd:Command ;
    rdfs:label "Load Ontology" ;
    rdfs:comment "Load an RDF ontology from file" ;
    ddd:hasParameter ggen:path .

ggen:GenerateCodeCommand a ddd:Command ;
    rdfs:label "Generate Code" ;
    rdfs:comment "Generate code from ontology using templates" ;
    ddd:hasParameter ggen:id ;
    ddd:hasParameter ggen:path .

# Events
ggen:OntologyLoaded a ddd:DomainEvent ;
    rdfs:label "Ontology Loaded" ;
    ddd:hasProperty ggen:id ;
    ddd:hasProperty ggen:timestamp .

ggen:CodeGenerated a ddd:DomainEvent ;
    rdfs:label "Code Generated" ;
    ddd:hasProperty ggen:receiptId ;
    ddd:hasProperty ggen:path .

# Value Object Definitions
ggen:OntologyId a ddd:ValueObject ;
    rdfs:label "OntologyId" ;
    rdfs:comment "Unique identifier for ontology" ;
    ddd:hasProperty ggen:id ;
    ddd:hasInvariant [
        rdfs:label "Must be non-empty" ;
        ddd:check "!self.id.is_empty()" ;
        ddd:message "OntologyId cannot be empty"
    ] .

ggen:ReceiptId a ddd:ValueObject ;
    rdfs:label "ReceiptId" ;
    rdfs:comment "Receipt identifier with provenance" ;
    ddd:hasProperty ggen:receiptId ;
    ddd:hasInvariant [
        rdfs:label "Must be non-empty" ;
        ddd:check "!self.receipt_id.is_empty()" ;
        ddd:message "ReceiptId cannot be empty"
    ] .

ggen:SPARQLQuery a ddd:ValueObject ;
    rdfs:label "SPARQLQuery" ;
    rdfs:comment "SPARQL query string with validation" ;
    ddd:hasProperty [
        rdfs:label "query_text" ;
        ddd:type "String"
    ] ;
    ddd:hasInvariant [
        rdfs:label "Must be valid SPARQL" ;
        ddd:check "self.query_text.starts_with(\"SELECT\") || self.query_text.starts_with(\"CONSTRUCT\")" ;
        ddd:message "SPARQLQuery must start with SELECT or CONSTRUCT"
    ] .

ggen:Template a ddd:ValueObject ;
    rdfs:label "Template" ;
    rdfs:comment "Tera template content" ;
    ddd:hasProperty [
        rdfs:label "template_content" ;
        ddd:type "String"
    ] ;
    ddd:hasInvariant [
        rdfs:label "Must contain template markers" ;
        ddd:check "self.template_content.contains(\"{{\")" ;
        ddd:message "Template must contain template markers {{}}"
    ] .

# Repository Trait
ggen:OntologyRepository a ddd:Repository ;
    rdfs:label "OntologyRepository" ;
    ddd:forAggregate ggen:Ontology ;
    ddd:hasMethod [ rdfs:label "find_by_id"; ddd:returns "Option<Ontology>" ] ;
    ddd:hasMethod [ rdfs:label "save"; ddd:param "ontology: Ontology" ] ;
    ddd:hasMethod [ rdfs:label "delete"; ddd:param "id: &str" ] .

ggen:ReceiptRepository a ddd:Repository ;
    rdfs:label "ReceiptRepository" ;
    ddd:forAggregate ggen:Receipt ;
    ddd:hasMethod [ rdfs:label "find_by_id"; ddd:returns "Option<Receipt>" ] ;
    ddd:hasMethod [ rdfs:label "save"; ddd:param "receipt: Receipt" ] ;
    ddd:hasMethod [ rdfs:label "all"; ddd:returns "Vec<Receipt>" ] .

# Service
ggen:OntologyService a ddd:Service ;
    rdfs:label "OntologyService" ;
    ddd:uses ggen:OntologyRepository ;
    ddd:hasMethod [ rdfs:label "load_ontology"; ddd:returns "Ontology" ] ;
    ddd:hasMethod [ rdfs:label "get_ontology"; ddd:returns "Option<Ontology>" ] .

ggen:GenerationService a ddd:Service ;
    rdfs:label "GenerationService" ;
    ddd:uses ggen:ReceiptRepository ;
    ddd:hasMethod [ rdfs:label "generate_code"; ddd:returns "Receipt" ] ;
    ddd:hasMethod [ rdfs:label "get_receipts"; ddd:returns "Vec<Receipt>" ] .

# Handlers
ggen:LoadOntologyHandler a ddd:Handler ;
    rdfs:label "LoadOntologyHandler" ;
    ddd:handles ggen:LoadOntologyCommand ;
    ddd:emits ggen:OntologyLoaded .

ggen:GenerateCodeHandler a ddd:Handler ;
    rdfs:label "GenerateCodeHandler" ;
    ddd:handles ggen:GenerateCodeCommand ;
    ddd:emits ggen:CodeGenerated .

# Policies
ggen:CompletenessPolicy a ddd:Policy ;
    rdfs:label "CompletenessPolicy" ;
    ddd:validates ggen:Ontology ;
    ddd:validates ggen:Receipt .

ggen:DeterminismPolicy a ddd:Policy ;
    rdfs:label "DeterminismPolicy" ;
    ddd:ensures "deterministic_generation" ;
    ddd:verifies "hash_integrity" .

# Test Definitions
ggen:OntologyLoadTest a ddd:Test ;
    rdfs:label "OntologyLoadTest" ;
    rdfs:comment "Test ontology loading and validation" ;
    ddd:tests ggen:OntologyLoaded ;
    ddd:hasArrange "let ontology = Ontology::new(\"ont-test123\".into(), \"path/to/onto.ttl\".into())" ;
    ddd:hasAct "ontology.validate()" ;
    ddd:hasAssert "assert!(!ontology.id.is_empty())" .

ggen:ReceiptGenerationTest a ddd:Test ;
    rdfs:label "ReceiptGenerationTest" ;
    rdfs:comment "Test code generation receipt creation" ;
    ddd:tests ggen:CodeGenerated ;
    ddd:hasArrange "let receipt = Receipt::new(\"receipt-123\".into(), \"h1\".into(), \"h2\".into(), \"h3\".into())" ;
    ddd:hasAct "receipt.validate()" ;
    ddd:hasAssert "assert_eq!(receipt.receipt_id, \"receipt-123\")" .

ggen:RepositoryPersistenceTest a ddd:Test ;
    rdfs:label "RepositoryPersistenceTest" ;
    rdfs:comment "Test repository save/retrieve" ;
    ddd:tests ggen:OntologyRepository ;
    ddd:hasArrange "let mut repo = InMemoryOntologyRepository::new(); let ont = Ontology::new(\"ont-x\".into(), \"path\".into())" ;
    ddd:hasAct "repo.save(ont.clone()); let retrieved = repo.find_by_id(\"ont-x\")" ;
    ddd:hasAssert "assert_eq!(retrieved, Some(ont))" .