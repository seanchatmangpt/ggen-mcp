// =============================================================================
// AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
// Generated by ggen from RDF ontology
// Regenerate with: ggen sync
// =============================================================================
//! MCP Tool Handlers
//! Generated from ggen-mcp.ttl - DO NOT EDIT MANUALLY
//!
//! This module contains the generated tool handler implementations for the
//! MCP (Model Context Protocol) server. Each tool is defined in the ontology
//! and automatically generates:
//! - The #[tool(...)] attribute macro with name and description
//! - The async handler function
//! - Error handling with MCP error conversion
//! - Timeout wrapper for tool execution

use crate::model::*;
use crate::state::AppState;
use crate::tools;
use anyhow::Result;
use rmcp::{
    ErrorData as McpError, Json,
    handler::server::wrapper::Parameters,
    tool,
};
use std::sync::Arc;

use super::mcp_tool_params::*;

// Helper function to convert errors to MCP errors
fn to_mcp_error(error: anyhow::Error) -> McpError {
    McpError::internal_error(error.to_string(), None)
}

/// Handler for the `list_workbooks` tool
///
/// List spreadsheet files in the workspace
#[tool(
    name = "list_workbooks",
    description = "List spreadsheet files in the workspace"
)]
pub async fn list_workbooks(
    server: &crate::server::SpreadsheetServer,
    Parameters(params): Parameters<ListWorkbooksParams>,
) -> Result<Json<WorkbookListResponse>, McpError> {
    server
        .ensure_tool_enabled("list_workbooks")
        .map_err(to_mcp_error)?;
    server
        .run_tool_with_timeout(
            "list_workbooks",
            tools::list_workbooks(server.state.clone(), params.into()),
        )
        .await
        .map(Json)
        .map_err(to_mcp_error)
}

/// Handler for the `describe_workbook` tool
///
/// Describe workbook metadata
#[tool(
    name = "describe_workbook",
    description = "Describe workbook metadata"
)]
pub async fn describe_workbook(
    server: &crate::server::SpreadsheetServer,
    Parameters(params): Parameters<DescribeWorkbookParams>,
) -> Result<Json<WorkbookDescription>, McpError> {
    server
        .ensure_tool_enabled("describe_workbook")
        .map_err(to_mcp_error)?;
    server
        .run_tool_with_timeout(
            "describe_workbook",
            tools::describe_workbook(server.state.clone(), params.into()),
        )
        .await
        .map(Json)
        .map_err(to_mcp_error)
}

/// Handler for the `workbook_summary` tool
///
/// Summarize workbook regions and entry points
#[tool(
    name = "workbook_summary",
    description = "Summarize workbook regions and entry points"
)]
pub async fn workbook_summary(
    server: &crate::server::SpreadsheetServer,
    Parameters(params): Parameters<WorkbookSummaryParams>,
) -> Result<Json<WorkbookSummaryResponse>, McpError> {
    server
        .ensure_tool_enabled("workbook_summary")
        .map_err(to_mcp_error)?;
    server
        .run_tool_with_timeout(
            "workbook_summary",
            tools::workbook_summary(server.state.clone(), params.into()),
        )
        .await
        .map(Json)
        .map_err(to_mcp_error)
}

/// Handler for the `list_sheets` tool
///
/// List sheets with summaries
#[tool(
    name = "list_sheets",
    description = "List sheets with summaries"
)]
pub async fn list_sheets(
    server: &crate::server::SpreadsheetServer,
    Parameters(params): Parameters<ListSheetsParams>,
) -> Result<Json<SheetListResponse>, McpError> {
    server
        .ensure_tool_enabled("list_sheets")
        .map_err(to_mcp_error)?;
    server
        .run_tool_with_timeout(
            "list_sheets",
            tools::list_sheets(server.state.clone(), params.into()),
        )
        .await
        .map(Json)
        .map_err(to_mcp_error)
}

/// Handler for the `sheet_overview` tool
///
/// Get narrative overview for a sheet
#[tool(
    name = "sheet_overview",
    description = "Get narrative overview for a sheet"
)]
pub async fn sheet_overview(
    server: &crate::server::SpreadsheetServer,
    Parameters(params): Parameters<SheetOverviewParams>,
) -> Result<Json<SheetOverviewResponse>, McpError> {
    server
        .ensure_tool_enabled("sheet_overview")
        .map_err(to_mcp_error)?;
    server
        .run_tool_with_timeout(
            "sheet_overview",
            tools::sheet_overview(server.state.clone(), params.into()),
        )
        .await
        .map(Json)
        .map_err(to_mcp_error)
}

/// Handler for the `read_table` tool
///
/// Read structured data from a range or table
#[tool(
    name = "read_table",
    description = "Read structured data from a range or table"
)]
pub async fn read_table(
    server: &crate::server::SpreadsheetServer,
    Parameters(params): Parameters<ReadTableParams>,
) -> Result<Json<ReadTableResponse>, McpError> {
    server
        .ensure_tool_enabled("read_table")
        .map_err(to_mcp_error)?;
    server
        .run_tool_with_timeout(
            "read_table",
            tools::read_table(server.state.clone(), params.into()),
        )
        .await
        .map(Json)
        .map_err(to_mcp_error)
}

/// Handler for the `table_profile` tool
///
/// Profile a region or table
#[tool(
    name = "table_profile",
    description = "Profile a region or table"
)]
pub async fn table_profile(
    server: &crate::server::SpreadsheetServer,
    Parameters(params): Parameters<TableProfileParams>,
) -> Result<Json<TableProfileResponse>, McpError> {
    server
        .ensure_tool_enabled("table_profile")
        .map_err(to_mcp_error)?;
    server
        .run_tool_with_timeout(
            "table_profile",
            tools::table_profile(server.state.clone(), params.into()),
        )
        .await
        .map(Json)
        .map_err(to_mcp_error)
}

// =============================================================================
// Tool Router Registration
// =============================================================================

/// Macro to register all generated tools with the tool router
///
/// Usage in SpreadsheetServer:
/// ```rust,ignore
/// #[tool_router]
/// impl SpreadsheetServer {
///     // ... include generated tools ...
/// }
/// ```
///
/// Tools defined in this file (from ontology):
/// - list_workbooks
/// - describe_workbook
/// - workbook_summary
/// - list_sheets
/// - sheet_overview
/// - read_table
/// - table_profile

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_tool_count() {
        // Verify expected number of tools generated
        let tools: Vec<&str> = vec![
            "list_workbooks",
            "describe_workbook",
            "workbook_summary",
            "list_sheets",
            "sheet_overview",
            "read_table",
            "table_profile",
        ];
        assert_eq!(tools.len(), 7, "Expected 7 tools from ontology");
    }
}
