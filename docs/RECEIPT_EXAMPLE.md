# Cryptographic Receipt Examples

This document provides example receipts generated by the ggen-mcp compilation system,
demonstrating proof-carrying code capabilities.

## Overview

Receipts provide cryptographic proof of:
- **Input provenance**: All source files with SHA-256 hashes
- **Guard verdicts**: Validation and security check results
- **Output artifacts**: Generated files with content hashes
- **Reproducibility**: Complete audit trail for deterministic builds

## Schema Location

JSON Schema: `schemas/receipt.json`

Implementation: `src/tools/ggen_sync/receipt.rs`

## Example 1: Successful Preview Build

```json
{
  "version": "1.0.0",
  "workspace": {
    "root": "/home/user/ggen-mcp",
    "fingerprint": "d4735e3a265e16eee03f59718b9b5d03019c07d8b6c51f90da3a666eec13ab35"
  },
  "inputs": {
    "config": {
      "path": "/home/user/ggen-mcp/ggen.toml",
      "hash": "a4c2f8e3b1d9a8c7b5e3f9d2c1a8b7e5f3d9c2b1a8f7e5d3c2b1a9f8e7d6c5b4",
      "rules_count": 42
    },
    "ontologies": [
      {
        "path": "/home/user/ggen-mcp/ontology/mcp-domain.ttl",
        "hash": "9b7d3c2e1f5a8b6d4c2f9e7b5a3d1c8f6e4b2a9d7c5e3b1f8d6c4a2e9b7d5c3",
        "triple_count": 2847
      }
    ],
    "queries": [
      {
        "path": "/home/user/ggen-mcp/queries/mcp_tools.rq",
        "hash": "3f8d2a1c9e7b5d4f2a9c8e6b4d3f1a8c7e5b3d2f9c8e6a4b3d1f9c8e7b6d5a4"
      },
      {
        "path": "/home/user/ggen-mcp/queries/fork_operations.rq",
        "hash": "7c2e9b4d1f8a6c3e9b7d5a2f8c6e4b3d1a9f7c5e3b2d9f8c7e6a5b4d3f2a1c9"
      }
    ],
    "templates": [
      {
        "path": "/home/user/ggen-mcp/templates/mcp_tools.rs.tera",
        "hash": "5e4c3b2a1d9f8e7c6b5a4d3f2e1c9b8a7d6e5f4c3b2a1d9f8e7c6b5a4d3f2e1"
      },
      {
        "path": "/home/user/ggen-mcp/templates/fork_operations.rs.tera",
        "hash": "1a9f8e7d6c5b4a3f2e1d9c8b7a6f5e4d3c2b1a9f8e7d6c5b4a3f2e1d9c8b7a6"
      }
    ]
  },
  "guards": {
    "kernel_version": "1.0.0",
    "verdicts": [
      {
        "name": "syntax_check",
        "verdict": "pass",
        "diagnostic": "All generated Rust code passes syn::parse_file validation",
        "metadata": {
          "files_checked": "42",
          "duration_ms": "187"
        }
      },
      {
        "name": "security_scan",
        "verdict": "pass",
        "diagnostic": "No unsafe blocks, no unwrap() calls, all paths validated",
        "metadata": {
          "unsafe_blocks": "0",
          "unwrap_calls": "0",
          "path_traversal_checks": "42"
        }
      },
      {
        "name": "determinism_check",
        "verdict": "pass",
        "diagnostic": "No TODO/FIXME markers, consistent formatting",
        "metadata": {
          "todo_count": "0",
          "fixme_count": "0"
        }
      }
    ]
  },
  "outputs": [
    {
      "path": "src/generated/mcp_tools.rs",
      "hash": "c8f7e6d5b4a3f2e1d9c8b7a6f5e4d3c2b1a9f8e7d6c5b4a3f2e1d9c8b7a6f5e4",
      "size": 45293,
      "language": "rust"
    },
    {
      "path": "src/generated/fork_operations.rs",
      "hash": "f2e1d9c8b7a6f5e4d3c2b1a9f8e7d6c5b4a3f2e1d9c8b7a6f5e4d3c2b1a9f8e7",
      "size": 28741,
      "language": "rust"
    }
  ],
  "metadata": {
    "timestamp": "2026-01-20T20:45:33.127Z",
    "compiler_version": "0.1.0",
    "mode": "preview",
    "status": "pass",
    "performance": {
      "total_duration_ms": 2847,
      "discovery_ms": 142,
      "guards_ms": 187,
      "sparql_ms": 891,
      "render_ms": 1247,
      "validate_ms": 380
    }
  }
}
```

## Example 2: Failed Build with Guard Violations

```json
{
  "version": "1.0.0",
  "workspace": {
    "root": "/home/user/ggen-mcp",
    "fingerprint": "d4735e3a265e16eee03f59718b9b5d03019c07d8b6c51f90da3a666eec13ab35"
  },
  "inputs": {
    "config": {
      "path": "/home/user/ggen-mcp/ggen.toml",
      "hash": "a4c2f8e3b1d9a8c7b5e3f9d2c1a8b7e5f3d9c2b1a8f7e5d3c2b1a9f8e7d6c5b4",
      "rules_count": 42
    },
    "ontologies": [
      {
        "path": "/home/user/ggen-mcp/ontology/mcp-domain.ttl",
        "hash": "9b7d3c2e1f5a8b6d4c2f9e7b5a3d1c8f6e4b2a9d7c5e3b1f8d6c4a2e9b7d5c3",
        "triple_count": 2847
      }
    ],
    "queries": [],
    "templates": []
  },
  "guards": {
    "kernel_version": "1.0.0",
    "verdicts": [
      {
        "name": "syntax_check",
        "verdict": "fail",
        "diagnostic": "Parse error in generated code: expected `;` at line 147",
        "metadata": {
          "file": "src/generated/invalid_tool.rs",
          "line": "147",
          "column": "34"
        }
      },
      {
        "name": "security_scan",
        "verdict": "fail",
        "diagnostic": "Found 3 unsafe blocks without justification comments",
        "metadata": {
          "unsafe_blocks": "3",
          "files": "src/generated/risky_operations.rs"
        }
      }
    ]
  },
  "outputs": [],
  "metadata": {
    "timestamp": "2026-01-20T20:47:12.441Z",
    "compiler_version": "0.1.0",
    "mode": "apply",
    "status": "fail",
    "performance": {
      "total_duration_ms": 1523,
      "discovery_ms": 98,
      "guards_ms": 142,
      "sparql_ms": 687,
      "render_ms": 421,
      "validate_ms": 175
    }
  }
}
```

## Verification Workflow

### 1. Generate Receipt
```bash
# Run sync with receipt generation (enabled by default)
mcp call sync_ggen '{"workspace_root": ".", "preview": false, "emit_receipt": true}'
```

### 2. Verify Receipt
```rust
use ggen_mcp::tools::ggen_sync::receipt::{Receipt, ReceiptGenerator};

// Load receipt
let receipt = ReceiptGenerator::load(Path::new(".ggen/receipts/sync-20260120-204533.json"))?;

// Verify integrity
let is_valid = ReceiptGenerator::verify(&receipt)?;
if is_valid {
    println!("✓ Receipt verified: all hashes match");
} else {
    println!("✗ Receipt verification failed: hashes do not match");
}
```

### 3. Check Reproducibility
```bash
# Run sync twice, compare receipts
mcp call sync_ggen '{"workspace_root": ".", "force": true}' > receipt1.json
mcp call sync_ggen '{"workspace_root": ".", "force": true}' > receipt2.json

# Compare output hashes (should be identical)
diff <(jq -S '.outputs[].hash' receipt1.json) \
     <(jq -S '.outputs[].hash' receipt2.json)
```

## Receipt Storage

Receipts are stored in `.ggen/receipts/` with timestamped filenames:

```
.ggen/
├── receipts/
│   ├── sync-20260120-204533.json
│   ├── sync-20260120-205821.json
│   └── sync-20260120-211042.json
└── cache/
    └── ... (SPARQL query cache)
```

## Use Cases

### 1. Supply Chain Security
Prove that generated code came from specific ontology + template versions:
```bash
# Extract provenance
jq '.inputs | {ontologies, templates}' .ggen/receipts/sync-latest.json
```

### 2. Reproducible Builds
Verify builds are deterministic across environments:
```bash
# Compare hashes from two machines
diff machine1-receipt.json machine2-receipt.json
```

### 3. Audit Trail
Track all code generation events with cryptographic proof:
```bash
# List all receipts chronologically
ls -lt .ggen/receipts/
```

### 4. Guard Compliance
Verify all security guards passed before deployment:
```bash
# Check guard status
jq '.guards.verdicts[] | select(.verdict == "fail")' receipt.json
```

## Schema Evolution

The receipt schema follows semantic versioning:
- **Version 1.0.0**: Initial release (current)
- Future versions will maintain backward compatibility
- Version mismatches trigger warnings during verification

## Related Documentation

- [JSON Schema](../schemas/receipt.json) - Formal schema definition
- [Receipt Generation](../src/tools/ggen_sync/receipt.rs) - Implementation
- [ggen Sync Tool](../src/tools/ggen_sync/mod.rs) - Pipeline integration
- [Audit Trail](./AUDIT_TRAIL.md) - Event logging system
